
"""steamui 521:
data: b'\x01\x00\x00\x00\x07\x00\x00\x00\x00'

steamui 548:
2024-06-06 16:22:08     CMUDP27017    CRITICAL packet_id: ClientAppInfoRequest_obsolete (840)
b'\x97\x01\x00\x00\x00\n\x00\x00\x00\x01\n\x00\x00\x00\x00\x0f\x00\x00\x00\x01\x0f\x00\x00\x00
\x02\x12\x00\x00\x00\x03\x12\x00\x00\x00\x04\r\x00\x00\x00\x03\r\x00\x00\x00\x05\x00\x00\x00
\x00\x03\x00\x00\x00\x00\x06\x10\x00\x00\x00\x05\x10\x00\x00\x00\x07\x00\x00\x00\x00\n\x00
\x00\x00\x00\x00\x00\x00\x00\x00_\x00\x00\x00\x00\x0b\x00\x00\x00\x00\x01\x00\x00\x00\x00\xca
\x00\x00\x00\x00\n\x0f\x00\x00\x00\x0b\x0f\x00\x00\x00\n\x19\x00\x00\x00\x0b\x19\x00\x00\x00
\x0c+\x00\x00\x00\r+\x00\x00\x00\x0e+\x00\x00\x00\x0c?\x00\x00\x00\r?\x00\x00\x00\x0e\r\x00
\x00\x00\r\r\x00\x00\x00\x12\x1b\x00\x00\x00\x13\x1b\x00\x00\x00\x14\n\x00\x00\x00\x15\n\x00
\x00\x00\x16?\x00\x00\x00\x17?\x00\x00\x00\x18\r\x00\x00\x00\x17\r\x00\x00\x00\x1a\x1d\x00\x00
\x00\xfd\x1c\x00\x00\x00\x1a\'\x00\x00\x00\x1b\'\x00\x00\x00\x1c\x1b\x00\x00\x00\x1d\x1b\x00\x00
\x00\x1e\x1e\x00\x00\x00\x1f\x1e\x00\x00\x00 ?\x00\x00\x00!?\x00\x00\x00"\r\x00\x00\x00!\r\x00\x00
\x00&\x1b\x00\x00\x00\'\x1b\x00\x00\x00& \x00\x00\x00\' \x00\x00\x00&%\x00\x00\x00\'%\x00\x00\x00*?
\x00\x00\x00+?\x00\x00\x00,\r\x00\x00\x00+\r\x00\x00\x00.\x13\x00\x00\x00%\x13\x00\x00\x006\x01\x00
\x00\x001\x01\x00\x00\x002\x01\x00\x00\x003\x01\x00\x00\x006\r\x00\x00\x005\r\x00\x00\x00>\x1c\x00
\x00\x00?\x1c\x00\x00\x00>!\x00\x00\x005!\x00\x00\x006!\x00\x00\x00@\r\x00\x00\x00?\r\x00\x00\x00B\'
\x00\x00\x00C\'\x00\x00\x00H\x08\x00\x00\x005\x08\x00\x00\x006\x08\x00\x00\x007\x08\x00\x00\x008\x08
\x00\x00\x009\x08\x00\x00\x00:\x08\x00\x00\x00;\x08\x00\x00\x00<\x08\x00\x00\x00J\r\x00\x00\x00I\r
\x00\x00\x00P\x00\x00\x00\x00Q\x00\x00\x00\x00P-\x00\x00\x00Q-\x00\x00\x00R-\x00\x00\x00T\r\x00\x00
\x00S\r\x00\x00\x00T$\x00\x00\x00U$\x00\x00\x00V$\x00\x00\x00V\x18\x00\x00\x00W\x18\x00\x00\x00X\x11\x00\x00\x00Y\x11\x00\x00\x00Z\x11\x00\x00\x00\\\x00\x00\x00\x00^\r\x00\x00\x00]\r\x00\x00\x00^\x1f\x00\x00\x00_\x1f\x00\x00\x00a\x08\x00\x00\x00`\x08\x00\x00\x00T\x08\x00\x00\x00U\x08\x00\x00\x00V\x08\x00\x00\x00W\x08\x00\x00\x00c\t\x00\x00\x00b\t\x00\x00\x00d\x00\x00\x00\x00e\x00\x00\x00\x00f\x00\x00\x00\x00g\x00\x00\x00\x00f\x12\x00\x00\x00g\x12\x00\x00\x00h\r\x00\x00\x00g\r\x00\x00\x00h$\x00\x00\x00i$\x00\x00\x00n2\x00\x00\x00f2\x00\x00\x00p\x1c\x00\x00\x00q\x1c\x00\x00\x00r\x1c\x00\x00\x00r\r\x00\x00\x00q\r\x00\x00\x00r$\x00\x00\x00s$\x00\x00\x00t\x18\x00\x00\x00u\x18\x00\x00\x00t"\x00\x00\x00u"\x00\x00\x00v\x1b\x00\x00\x00w\x1b\x00\x00\x00x#\x00\x00\x00y#\x00\x00\x00z\x1c\x00\x00\x00{\x1c\x00\x00\x00|\r\x00\x00\x00{\r\x00\x00\x00~@\x00\x00\x00\x7f@\x00\x00\x00\x82\x19\x00\x00\x00\x83\x19\x00\x00\x00\x82#\x00\x00\x00\x83#\x00\x00\x00\x84\x03\x00\x00\x00\x8e\x03\x00\x00\x00\x85\x03\x00\x00\x00\x86\x03\x00\x00\x00\x86\r\x00\x00\x00\x85\r\x00\x00\x00\x86\x1f\x00\x00\x00\x87\x1f\x00\x00\x00\x86.\x00\x00\x00}.\x00\x00\x00\x87\x03\x00\x00\x00\x88\x03\x00\x00\x00\x88\x13\x00\x00\x00\x89\x03\x00\x00\x00\x89\x13\x00\x00\x00\x8a\x03\x00\x00\x00\x8a\x0c\x00\x00\x00\x8b\x0c\x00\x00\x00\x8a\x13\x00\x00\x00\x8a\x1b\x00\x00\x00\x8b\x1b\x00\x00\x00\x8b\x03\x00\x00\x00\x8b\x13\x00\x00\x00\x8c\x03\x00\x00\x00\x8c\x13\x00\x00\x00\x8c\x19\x00\x00\x00\x8d\x19\x00\x00\x00\x8c\x1e\x00\x00\x00\x8d\x1e\x00\x00\x00\x8c#\x00\x00\x00\x8d#\x00\x00\x00\x8d\x03\x00\x00\x00\x8d\x13\x00\x00\x00\x8e\x13\x00\x00\x00\x8f\x13\x00\x00\x00\x90\x03\x00\x00\x00\x90\r\x00\x00\x00\x8f\r\x00\x00\x00\x90\x13\x00\x00\x00\x91\x03\x00\x00\x00\x91\x13\x00\x00\x00\x92\x03\x00\x00\x00\x92\x13\x00\x00\x00\x93\x03\x00\x00\x00\x93\x13\x00\x00\x00\x94\x03\x00\x00\x00\x94\x13\x00\x00\x00\x95\x03\x00\x00\x00\x95\x13\x00\x00\x00\x96\x03\x00\x00\x00\x96\x13\x00\x00\x00\x97\x03\x00\x00\x00\x97\x13\x00\x00\x00\x98\x03\x00\x00\x00\x98\x13\x00\x00\x00\x99\x03\x00\x00\x00\x99\x13\x00\x00\x00\x9a\x01\x00\x00\x00\x9b\x01\x00\x00\x00\xd8\x00\x00\x00\x00\x91\x01\x00\x00\x00\xce\x00\x00\x00\x00\xcf\x00\x00\x00\x00\xd0\x00\x00\x00\x00\x9a\x03\x00\x00\x00\x9a\r\x00\x00\x00\x99\r\x00\x00\x00\x9a\x1f\x00\x00\x00\x9b\x1f\x00\x00\x00\x9b\x03\x00\x00\x00\x9b\x13\x00\x00\x00\x9c\x03\x00\x00\x00\x9c\x13\x00\x00\x00\x9d\x03\x00\x00\x00\x9d\x13\x00\x00\x00\x9e\x03\x00\x00\x00\x9e\x13\x00\x00\x00\x9f\x03\x00\x00\x00\x9f\x13\x00\x00\x00\xa0\x03\x00\x00\x00\xa0\x13\x00\x00\x00\xa0#\x00\x00\x00\xa1#\x00\x00\x00\xa1\x03\x00\x00\x00\xa1\x13\x00\x00\x00\xa2\x03\x00\x00\x00\xa3\x03\x00\x00\x00\xa4\x03\x00\x00\x00\xa4\r\x00\x00\x00\xa3\r\x00\x00\x00\xa4\x10\x00\x00\x00\xa5\x10\x00\x00\x00\xa4\x13\x00\x00\x00\xa5\x03\x00\x00\x00\xa6\x03\x00\x00\x00\xa6\x13\x00\x00\x00\xa7\x03\x00\x00\x00\xa7\x13\x00\x00\x00\xa8\x03\x00\x00\x00\xa8\x13\x00\x00\x00\xa8\x1b\x00\x00\x00\xa9\x1b\x00\x00\x00\xa9\x03\x00\x00\x00\xa9\x13\x00\x00\x00\xaa\x03\x00\x00\x00\xaa\n\x00\x00\x00\xab\n\x00\x00\x00\xa2\n\x00\x00\x00\xa3\n\x00\x00\x00\xaa\x13\x00\x00\x00\xaa#\x00\x00\x00\xab#\x00\x00\x00\xab\x03\x00\x00\x00\xab\x13\x00\x00\x00\xac\x03\x00\x00\x00\xac\x13\x00\x00\x00\xad\x03\x00\x00\x00\xad\x13\x00\x00\x00\xae\x03\x00\x00\x00\xae\x06\x00\x00\x00\xa5\x06\x00\x00\x00\xae\r\x00\x00\x00\xad\r\x00\x00\x00\xae\x10\x00\x00\x00\xae\x13\x00\x00\x00\xaf\x03\x00\x00\x00\xaf\x13\x00\x00\x00\xb0\x03\x00\x00\x00\xb0\x13\x00\x00\x00\xb0\x18\x00\x00\x00\xb1\x18\x00\x00\x00\xb1\x03\x00\x00\x00\xb1\x13\x00\x00\x00\xb2\x03\x00\x00\x00\xb2\x13\x00\x00\x00\xb3\x03\x00\x00\x00\xb4\x03\x00\x00\x00\xb4\x19\x00\x00\x00\xb5\x19\x00\x00\x00\xb5\x03\x00\x00\x00\xb6\x03\x00\x00\x00\xb6!\x00\x00\x00\xb7!\x00\x00\x00\xb7\x03\x00\x00\x00\xb7\x13\x00\x00\x00\xb8\r\x00\x00\x00\xb7\r\x00\x00\x00\xb9\x03\x00\x00\x00\xba\x03\x00\x00\x00\xbb\x03\x00\x00\x00\xbc\x03\x00\x00\x00\xbd\x03\x00\x00\x00\xbe\x03\x00\x00\x00\xbe\x19\x00\x00\x00\xbf\x19\x00\x00\x00\xbf\x03\x00\x00\x00\xc0\x03\x00\x00\x00\xc1\x03\x00\x00\x00\xc2\x03\x00\x00\x00\xc3\x03\x00\x00\x00\xc4\x03\x00\x00\x00\xc4,\x00\x00\x00\xc5,\x00\x00\x00\xc5\x03\x00\x00\x00\xc6\x03\x00\x00\x00\xc7\x03\x00\x00\x00\xc8\x03\x00\x00\x00\xc9\x03\x00\x00\x00\xca\x03\x00\x00\x00\xca\x12\x00\x00\x00\xcb\x12\x00\x00\x00\xca!\x00\x00\x00\x9c!\x00\x00\x00\xca+\x00\x00\x00\xcb+\x00\x00\x00\xcb\x03\x00\x00\x00\xcc\x03\x00\x00\x00\xcd\x00\x00\x00\x00\xcd\x03\x00\x00\x00\xce\x03\x00\x00\x00\xce\t\x00\x00\x00\xcf\t\x00\x00\x00\xce\x1d\x00\x00\x00\xcf\x1d\x00\x00\x00\xce,\x00\x00\x00\xcf,\x00\x00\x00\xcf\x03\x00\x00\x00\xd0\x03\x00\x00\x00\xd0\x0c\x00\x00\x00\xd1\x0c\x00\x00\x00\xd1\x03\x00\x00\x00\xd2\x03\x00\x00\x00\xd22\x00\x00\x00\xc92\x00\x00\x00\xd3\x03\x00\x00\x00\xd4\x03\x00\x00\x00\xd4\x12\x00\x00\x00\xd5\x12\x00\x00\x00\xd4+\x00\x00\x00\xd5+\x00\x00\x00\xd5\x03\x00\x00\x00\xd6\x03\x00\x00\x00\xd6\x10\x00\x00\x00\xcd\x10\x00\x00\x00\xd7\x03\x00\x00\x00\xd8\x03\x00\x00\x00\xd9\x03\x00\x00\x00\xda\x03\x00\x00\x00\xdb\x00\x00\x00\x00\xc8\x00\x00\x00\x00\xdd\x00\x00\x00\x00\xdb\x03\x00\x00\x00\xdc\x03\x00\x00\x00\xdd\x03\x00\x00\x00\xde\x03\x00\x00\x00\xde\x05\x00\x00\x00\xdf\x05\x00\x00\x00\xde\x17\x00\x00\x00\xd5\x17\x00\x00\x00\xde!\x00\x00\x00\xdf\x03\x00\x00\x00\xe0\x01\x00\x00\x00\xe1\x01\x00\x00\x00\xe0\x03\x00\x00\x00\xe0$\x00\x00\x00\xe1$\x00\x00\x00\xe2\x03\x00\x00\x00\xe3\x03\x00\x00\x00\xe4\x03\x00\x00\x00\xe5\x03\x00\x00\x00\xe6\x03\x00\x00\x00\xe6\x0c\x00\x00\x00\xe5\x0c\x00\x00\x00\xe7\x03\x00\x00\x00\xe7\t\x00\x00\x00\xe8\t\x00\x00\x00\xe8!\x00\x00\x00\xeb\x03\x00\x00\x00\xe8\x03\x00\x00\x00\xee\x11\x00\x00\x00\xef\x11\x00\x00\x00\xf0\x0c\x00\x00\x00\xef\x0c\x00\x00\x00\xf0\x1e\x00\x00\x00\xf1\x1e\x00\x00\x00\xf2\x05\x00\x00\x00\xf1\x05\x00\x00\x00\xf2\x1c\x00\x00\x00\xe9\x1c\x00\x00\x00\xf8*\x00\x00\x00\xf9*\x00\x00\x00\xfa*\x00\x00\x00\xfa\x0c\x00\x00\x00\xf9\x0c\x00\x00\x00'"""
import io
import pprint
import struct

from steam3.ClientManager.client import Client
from steam3.Types.emsg import EMsg
from steam3.Types.steam_types import AppInfoRequest, AppInfoSections
from steam3.cm_packet_utils import CMPacket, CMResponse
from steam3.messages.MsgClientAppInfoRequest import MsgClientAppInfoRequest
from steam3.messages.MsgClientAppInfoResponse import MsgClientAppInfoResponse
from steam3.utilities import InputStream
from steam3.Responses.appinfo_responses import build_appinfo_response, build_appinfochanges_response


def handle_ClientAppInfoRequest_obsolete(cmserver_obj, packet: CMPacket, client_obj: Client):
    client_address = client_obj.ip_port
    request = packet.CMRequest
    cmserver_obj.log.info(f"{client_address} Application Info Request")

    input_stream = InputStream(request.data)

    """num_of_apps_requested = input_stream.read_int32()
    appinfo_requests = []
    msg = MsgClientAppInfoRequest()
    msg.deserialize(io.BytesIO(request.data[4:]))

    # Access the parsed data
    for request in msg.appInfoRequests:
        print(f"App ID: {request.appId}, Request All Sections: {request.requestAllSections}")
        appinfo_requests.append(request.appId)
        # FIXME this is only for single appinfo file requests
        #for section, crc32 in request.localAppInfoSectionsCRC32.items():
        #    print(f"  Section {section}: CRC32 = {crc32}")"""
    appinfo_requests = [7, 240, 520]

    return build_appinfo_response(client_obj, appinfo_requests, True)


def handle_ClientAppInfoRequest(cmserver_obj, packet: CMPacket, client_obj: Client):
    client_address = client_obj.ip_port
    request = packet.CMRequest
    data = io.BytesIO(request.data)

    app_ids = []
    msg = MsgClientAppInfoRequest()
    msg.deserialize(data)

    # Access the parsed data
    for request in msg.appInfoRequests:
        app_ids.append(request.appId)

    return build_appinfo_response(client_obj, app_ids, False)


def handle_ClientAppInfoupdate(cmserver_obj, packet: CMPacket, client_obj: Client):

    client_address = client_obj.ip_port
    cmserver_obj.log.info(f"{client_address} Recieved CliantAppInfoUpdate Request")
    request = packet.CMRequest
    data = request.data
    last_change_number, send_change_list, = struct.unpack_from("<IB", data, 0)
    # FIXME we only send this response to newer clients (2010? or later), need to figure out when
    #return build_appinfochanges_response(client_obj, last_change_number, send_change_list)

    app_ids = [7, 240, 520]
    return build_appinfochanges_response(client_obj, app_ids, last_change_number, True)